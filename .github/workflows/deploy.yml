# Nome do seu workflow
name: Deploy para VPS Hostinger

# Define quando o workflow deve rodar
on:
  push:
    branches:
      - main # Roda toda vez que houver um push na branch 'main'

# Define os "trabalhos" que serão executados
jobs:
  deploy:
    # O tipo de máquina que vai rodar o workflow
    runs-on: ubuntu-latest

      # ... (cabeçalho e jobs) ...

      steps:
        # 1. Configura a chave SSH para poder se conectar à VPS
          - name: Configurar Chave SSH
          uses: webfactory/ssh-agent@v0.5.3
          with:
            ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

          # 2. Conecta na VPS e executa os comandos de deploy
          - name: Deploy na VPS
            run: |
              ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
                # NAVEGUE ATÉ A PASTA DO PROJETO NA VPS
                cd /home/pedro/banco-de-questoes-api
              
                # Baixa a versão mais recente do código
                echo "--> Baixando a versão mais recente do código..."
                git pull origin main
              
                # Reconstrói e reinicia os contêineres com Docker Compose
                echo "--> Reconstruindo e reiniciando os contêineres..."
                docker-compose build
                docker-compose up -d
              
                # EXECUTA O SCRIPT DE MIGRAÇÃO COM O ARQUIVO MAIS RECENTE
                echo "--> Executando o script de migração..."
                node migracao.js
              
                echo "--> Deploy concluído com sucesso!"
              EOF